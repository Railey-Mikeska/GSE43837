# ---- Install / load required packages ----
if (!requireNamespace("GEOquery", quietly = TRUE)) install.packages("GEOquery")
if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
if (!requireNamespace("limma", quietly = TRUE)) BiocManager::install("limma")
if (!requireNamespace("org.Hs.eg.db", quietly = TRUE)) BiocManager::install("org.Hs.eg.db")
if (!requireNamespace("clusterProfiler", quietly = TRUE)) BiocManager::install("clusterProfiler")
if (!requireNamespace("msigdbr", quietly = TRUE)) BiocManager::install("msigdbr")
if (!requireNamespace("enrichplot", quietly = TRUE)) BiocManager::install("enrichplot")

library(GEOquery)
library(dplyr)
library(tibble)
library(limma)
library(ggplot2)
library(ggrepel)
library(clusterProfiler)
library(msigdbr)
library(enrichplot)
library(cowplot)

# ---- 1. Download platform annotation for GPL1352 ----
plat <- getGEO("GPL1352", AnnotGPL = FALSE)
plat_tbl <- Table(plat)

# ---- 2. Extract probe → gene symbol mapping ----
probe2gene_manual <- plat_tbl %>%
  dplyr::select(PROBEID = ID, SYMBOL = `Gene Symbol`) %>%
  distinct() %>%
  filter(SYMBOL != "")  # remove empty symbols

# ---- 3. Download GSE43837 expression set ----
gse <- getGEO("GSE43837", GSEMatrix = TRUE)
expr_set <- gse[[1]]  # single platform

# ---- 4. Extract expression matrix ----
expr_mat <- exprs(expr_set)  # rows = probes, columns = samples

# Convert to data.frame and add PROBEID
expr_df <- as.data.frame(expr_mat) %>%
  rownames_to_column("PROBEID") %>%
  mutate(PROBEID_clean = sub("_3p_at$", "_at", PROBEID),
         PROBEID_clean = sub("_5p_at$", "_at", PROBEID))


expr_mapped <- expr_df %>%
  left_join(probe2gene_manual, by = c("PROBEID_clean" = "PROBEID"))


# ---- 6. Collapse multiple probes per gene (mean) ----
expr_by_probe <- expr_mapped %>%
  mutate(SYMBOL = ifelse(is.na(SYMBOL), PROBEID_clean, SYMBOL),
         SYMBOL_unique = make.unique(SYMBOL)) %>%
  column_to_rownames("SYMBOL_unique")




# ---- 7. Prepare metadata (if available in series) ----
metadata_raw <- pData(expr_set) %>%
  as_tibble(rownames = "gsm_id")

# Example: assign sample groups based on title / description
metadata <- metadata_raw %>%
  mutate(
    condition = case_when(
      str_detect(title, regex("primary", ignore_case = TRUE)) ~ "Primary",
      str_detect(title, regex("brain_met|metastatic", ignore_case = TRUE)) ~ "BrainMet",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(condition)) %>%
  group_by(condition) %>%
  mutate(rep = row_number()) %>%
  ungroup()

# Match expression columns to metadata order
expr_by_probe_1 <- expr_by_probe[, metadata$gsm_id]



# ---- Log2-transform expression ----
expr_log2 <- log2(expr_by_probe_1 + 1)  # add 1 to avoid log2(0)





# ---- Optional: Prefilter low-variance probes ----
# Compute standard deviation across samples
probe_sd <- apply(expr_log2, 1, sd)

# Keep only probes with sufficient variability
# You can adjust the threshold (0.25–0.5 typical)
keep <- probe_sd > 0.5
expr_filtered <- expr_log2[keep, ]

cat("Retained", sum(keep), "of", length(keep), "probes after filtering.\n")













# ---- Differential expression using limma ----
design <- model.matrix(~0 + factor(metadata$condition))
colnames(design) <- levels(factor(metadata$condition))

fit <- lmFit(expr_filtered, design)

contrast.matrix <- makeContrasts(
  BrainMet_vs_Primary = BrainMet - Primary,
  levels = design
)

fit2 <- contrasts.fit(fit, contrast.matrix)
fit2 <- eBayes(fit2)

# ---- Extract top genes (probes) ----
top_genes <- topTable(fit2, coef = "BrainMet_vs_Primary", number = Inf, adjust.method = "fdr") %>%
  rownames_to_column(var = "Probe")

# ---- Volcano plot ----
library(ggplot2)
library(ggrepel)

# Add a discrete color column based on logFC
library(ggrepel)





# ---- Create volcano dataframe ----
volcano <- top_genes %>%
  mutate(
    fc_color = case_when(
      logFC >  2  ~ "red",
      logFC < -2  ~ "blue",
      TRUE        ~ "grey60"
    )
  )



# Subset only the red and blue genes for labeling
volcano_labels <- volcano %>%
  filter(fc_color %in% c("red", "blue"))

ggplot(volcano, aes(x = logFC, y = -log10(adj.P.Val), color = fc_color)) +
  geom_point(alpha = 0.6, size = 1.5) +
  geom_text_repel(
    data = volcano_labels,
    aes(label = Probe),
    size = 3,
    max.overlaps = 20
  ) +
  scale_color_identity() +
  geom_vline(xintercept = c(-2, 2), linetype = "dashed") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  theme_minimal() +
  labs(
    x = "log2 Fold Change",
    y = "-log10(P.Value)",
    title = "Volcano Plot (Red/Blue labeled, Gray not)"
  )




library(dplyr)
library(ggplot2)
library(ggrepel)

# ---- Tubulin and microtubule genes (uppercase) ----
tubulin_genes_upper <- toupper(c(
  "TUBB1", "TUBB2A", "TUBB2B", "TUBB3", "TUBB4", "TUBB5", "TUBB6",
  "TUBA1A", "TUBA1B", "TUBA1C", "TUBA3A", "TUBA4A", "TUBA8"
))


library(AnnotationDbi)
library(org.Hs.eg.db)

# ---- GO:0005874 microtubule cytoskeleton genes ----
go_mt_genes_0005874 <- AnnotationDbi::select(
  org.Hs.eg.db,
  keys = "GO:0005874",
  columns = c("SYMBOL", "GOALL"),
  keytype = "GOALL"
)



mt_genes_upper <- toupper(go_mt_genes_0005874$SYMBOL)



# ---- Prepare volcano data ----
volcano_mt <- top_genes %>%
  mutate(
    fc_color = case_when(
      logFC > 2  ~ "red",
      logFC < -2 ~ "blue",
      TRUE       ~ "grey60"
    ),
    Gene_upper = toupper(Probe),  # ensure consistent casing
    is_mtgene = Gene_upper %in% mt_genes_upper
  )

# ---- Subsets for labeling ----
volcano_labels_mt <- volcano_mt %>% filter(is_mtgene)         # MT genes
volcano_general   <- volcano_mt %>% filter(!is_mtgene)  


# ---- Volcano plot ----
library(ggplot2)
library(ggrepel)
library(cowplot)

ggplot() +
  # 1️⃣ General points (red/blue/gray)
  geom_point(
    data = volcano_general,
    aes(x = logFC, y = -log10(adj.P.Val), color = fc_color),
    alpha = 0.5, size = 1.5
  ) +
  # 2️⃣ MT genes (black, on top)
  geom_point(
    data = volcano_labels_mt,
    aes(x = logFC, y = -log10(adj.P.Val)),
    color = "black",
    size = 3
  ) +
  # 3️⃣ MT gene labels
  geom_text_repel(
    data = volcano_labels_mt,
    aes(x = logFC, y = -log10(adj.P.Val), label = Probe),
    color = "black",
    size = 3.5,
    max.overlaps = 20,
    box.padding = 0.5,
    point.padding = 0.3
  ) +
  # 4️⃣ Dashed thresholds
  geom_vline(xintercept = c(-2, 2), linetype = "dashed", color = "black", size = 0.5) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black", size = 0.5) +
  # 5️⃣ Color scale for red/blue/gray points
  scale_color_identity() +
  # 6️⃣ Cowplot theme
  theme_cowplot(font_size = 14) +
  labs(
    x = "log2 Fold Change",
    y = "-log10(adj.P.Val)",
    title = "Volcano Plot: Red/Blue/Gray + MT Genes (GO:0005874) in Black"
  )






























# ---- 11. GSEA (optional) ----
microtubule_genes <- msigdbr(species="Homo sapiens") %>%
  filter(gs_collection=="C5", str_detect(gs_name, "MICROTUBULE")) %>%
  select(gs_name, gene_symbol)

rankedgenes <- top_genes$logFC
names(rankedgenes) <- top_genes$Gene
rankedgenes <- sort(rankedgenes, decreasing = TRUE)
rankedgenes <- rankedgenes[!duplicated(names(rankedgenes))]

gsea_microtub <- GSEA(
  geneList = rankedgenes,
  TERM2GENE = microtubule_genes,
  pAdjustMethod = "fdr",
  pvalueCutoff = 0.05,
  minGSSize = 5,
  maxGSSize = 500
)

# Example plot for top microtubule gene set
top_set <- gsea_microtub@result$ID[1]
gseaplot(gsea_microtub, geneSetID = top_set)
